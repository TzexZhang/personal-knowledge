# CI/CD è‡ªåŠ¨åŒ–é…ç½®æŒ‡å—

> æ¯æ¬¡æ¨é€ä»£ç è‡ªåŠ¨éƒ¨ç½²ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

---

## ğŸ”„ è‡ªåŠ¨åŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Git Push        â”‚
â”‚  (main åˆ†æ”¯)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions  â”‚ â† è§¦å‘è‡ªåŠ¨åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚Railwayâ”‚  â”‚Vercel â”‚
â”‚åç«¯  â”‚  â”‚å‰ç«¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æˆåŠŸé€šçŸ¥  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å·²é…ç½®çš„æ–‡ä»¶

### 1. GitHub Actions å·¥ä½œæµ

**`.github/workflows/deploy.yml`**
- è‡ªåŠ¨éƒ¨ç½²åˆ° Railway å’Œ Vercel
- æ”¯æŒ push åˆ° main åˆ†æ”¯è§¦å‘
- æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰

**`.github/workflows/test.yml`**
- ä»£ç è´¨é‡æ£€æŸ¥
- æ„å»ºæµ‹è¯•
- éƒ¨ç½²å‰éªŒè¯

---

## ğŸ”‘ GitHub Secrets é…ç½®

### æ­¥éª¤ 1ï¼šè·å– Token

#### Railway Token
1. è®¿é—®ï¼šhttps://railway.app/
2. å³ä¸Šè§’å¤´åƒ â†’ **Account**
3. æ»šåŠ¨åˆ° **"API Tokens"**
4. ç‚¹å‡» **"New Token"**
5. è®¾ç½®ï¼š
   - Token åç§°ï¼š`github-actions`
   - æƒé™ï¼š**Read-Only** å³å¯
6. å¤åˆ¶ Tokenï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿ç®¡ï¼‰

#### Railway Project ID
1. æ‰“å¼€ Railway é¡¹ç›®é¡µé¢
2. æŸ¥çœ‹ URLï¼š`https://railway.app/p/PROJECT_ID/...`
3. å¤åˆ¶ PROJECT_ID éƒ¨åˆ†

#### Vercel Token
1. è®¿é—®ï¼šhttps://vercel.com/
2. å³ä¸Šè§’å¤´åƒ â†’ **Settings** â†’ **Tokens**
3. ç‚¹å‡» **"Create"**
4. Scope é€‰æ‹©ï¼š**Full Account**
5. å¤åˆ¶ Token

### æ­¥éª¤ 2ï¼šæ·»åŠ åˆ° GitHub

1. è¿›å…¥ GitHub ä»“åº“
2. **Settings** â†’ **Secrets and variables** â†’ **Actions**
3. ç‚¹å‡» **"New repository secret"**
4. æ·»åŠ ä»¥ä¸‹ secretsï¼š

| Name | Secret | è¯´æ˜ |
|------|--------|------|
| `RAILWAY_TOKEN` | `<Railway Token>` | Railway API Token |
| `RAILWAY_PROJECT_ID` | `<Railway Project ID>` | Railway é¡¹ç›® ID |
| `VERCEL_TOKEN` | `<Vercel Token>` | Vercel API Token |

### æ­¥éª¤ 3ï¼šéªŒè¯é…ç½®

è¿è¡Œæµ‹è¯•å·¥ä½œæµï¼š
```bash
# åœ¨ GitHub Actions é¡µé¢
# ç‚¹å‡» "Test" å·¥ä½œæµ
# ç‚¹å‡» "Run workflow"
# ç¡®ä¿æµ‹è¯•é€šè¿‡
```

---

## ğŸš€ è‡ªåŠ¨éƒ¨ç½²æµ‹è¯•

### ç¬¬ä¸€æ¬¡è‡ªåŠ¨éƒ¨ç½²

1. **æ¨é€ä»£ç **
```bash
git add .
git commit -m "test: trigger initial deployment"
git push origin main
```

2. **ç›‘æ§éƒ¨ç½²**
   - è¿›å…¥ GitHub ä»“åº“
   - ç‚¹å‡» **"Actions"** æ ‡ç­¾
   - æŸ¥çœ‹ **"Deploy to Production"** å·¥ä½œæµ
   - åº”è¯¥èƒ½çœ‹åˆ° 2 ä¸ªå¹¶è¡Œä»»åŠ¡ï¼š
     - âœ… Deploy to Railway
     - âœ… Deploy to Vercel

3. **éªŒè¯éƒ¨ç½²**
   - ç‚¹å‡»ä»»åŠ¡æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   - ç¡®ä¿ä¸¤ä¸ªä»»åŠ¡éƒ½æ˜¾ç¤ºç»¿è‰² âœ…

---

## ğŸ› ï¸ å·¥ä½œæµè¯¦è§£

### éƒ¨ç½²å·¥ä½œæµ (`.github/workflows/deploy.yml`)

```yaml
jobs:
  # éƒ¨ç½²åç«¯åˆ° Railway
  deploy-backend:
    steps:
      1. æ‹‰å–ä»£ç 
      2. å®‰è£… Railway CLI
      3. éƒ¨ç½²åˆ° Railway
      4. æ‰§è¡Œæ•°æ®åº“è¿ç§»
      5. é€šçŸ¥éƒ¨ç½²å®Œæˆ

  # éƒ¨ç½²å‰ç«¯åˆ° Vercel
  deploy-frontend:
    steps:
      1. æ‹‰å–ä»£ç 
      2. è®¾ç½® Node.js
      3. å®‰è£… Vercel CLI
      4. æ‹‰å–ç¯å¢ƒé…ç½®
      5. æ„å»ºé¡¹ç›®
      6. éƒ¨ç½²åˆ° Vercel
      7. åœ¨ PR ä¸­æ·»åŠ è¯„è®º
```

---

## ğŸ“Š ç›‘æ§éƒ¨ç½²çŠ¶æ€

### æŸ¥çœ‹éƒ¨ç½²å†å²

**Railway åç«¯**:
1. è¿›å…¥ Railway é¡¹ç›®
2. ç‚¹å‡»åç«¯ service
3. æŸ¥çœ‹ **"Deploys"** æ ‡ç­¾
4. å¯çœ‹åˆ°æ¯æ¬¡éƒ¨ç½²çš„å†å²è®°å½•

**Vercel å‰ç«¯**:
1. è¿›å…¥ Vercel é¡¹ç›®
2. æŸ¥çœ‹ **"Deployments"** æ ‡ç­¾
3. å¯çœ‹åˆ°æ¯æ¬¡éƒ¨ç½²çš„ï¼š
   - æäº¤ä¿¡æ¯
   - éƒ¨ç½²çŠ¶æ€
   - é¢„è§ˆé“¾æ¥

---

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹éƒ¨ç½²é¢‘ç‡

é»˜è®¤ï¼šæ¯æ¬¡ push åˆ° main åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²

**åªéƒ¨ç½²ç‰¹å®šæ–‡ä»¶**ï¼š
```yaml
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
```

**æ‰‹åŠ¨éƒ¨ç½²**ï¼š
```yaml
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
```

### æ·»åŠ éƒ¨ç½²æ­¥éª¤

åœ¨éƒ¨ç½²å‰æ·»åŠ æµ‹è¯•æ­¥éª¤ï¼š
```yaml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm test
      - run: pytest

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      # ... éƒ¨ç½²æ­¥éª¤
```

### æ·»åŠ é€šçŸ¥

**Slack é€šçŸ¥**ï¼š
```yaml
- name: Slack notification
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    webhook_url: ${{ secrets.SLACK_WEBHOOK }}
  if: always()
```

**é‚®ä»¶é€šçŸ¥**ï¼š
```yaml
- name: Send email
  uses: dawidd6/action-send-mail@v3
  with:
    server_address: smtp.gmail.com
    server_port: 465
    username: ${{ secrets.EMAIL_USERNAME }}
    password: ${{ secrets.EMAIL_PASSWORD }}
    subject: "éƒ¨ç½²å®Œæˆ"
    body: "åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
```

---

## ğŸ“ˆ é«˜çº§åŠŸèƒ½

### 1. å¤šç¯å¢ƒéƒ¨ç½²

```yaml
jobs:
  deploy-staging:
    environment: staging
    # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ

  deploy-production:
    environment: production
    # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
```

### 2. å›æ»šåŠŸèƒ½

```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
railway rollback
vercel rollback
```

### 3. è“ç»¿éƒ¨ç½²
```yaml
strategy:
  canary:  # é‡‘ä¸é›€éƒ¨ç½²
    canary-port: 10  # 10% æµé‡
```

---

## âš ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå·¥ä½œæµå¤±è´¥

**å¸¸è§åŸå› **ï¼š
1. Token è¿‡æœŸ â†’ é‡æ–°ç”Ÿæˆå¹¶æ›´æ–° Secret
2. æƒé™ä¸è¶³ â†’ æ£€æŸ¥ Token æƒé™
3. é…ç½®é”™è¯¯ â†’ æ£€æŸ¥ç¯å¢ƒå˜é‡

**è§£å†³æ–¹æ³•**ï¼š
1. æŸ¥çœ‹ Actions æ—¥å¿—
2. å®šä½å…·ä½“é”™è¯¯ä¿¡æ¯
3. ä¿®å¤åé‡æ–°éƒ¨ç½²

### é—®é¢˜ 2ï¼šéƒ¨ç½²æˆåŠŸä½†åŠŸèƒ½å¼‚å¸¸

**æ£€æŸ¥æ¸…å•**ï¼š
1. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
2. CORS æ˜¯å¦åŒ…å«æ­£ç¡®çš„å‰ç«¯åŸŸå
3. æ•°æ®åº“è¿ç§»æ˜¯å¦æˆåŠŸ

### é—®é¢˜ 3ï¼šæ•°æ®åº“è¿ç§»å¤±è´¥

**è§£å†³æ–¹æ³•**ï¼š
1. æ‰‹åŠ¨åœ¨ Railway Console æ‰§è¡Œè¿ç§»
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
3. ç¡®ä¿ PlanetScale æ•°æ®åº“å·²å¯ç”¨

---

## ğŸ“‹ ç»´æŠ¤æ¸…å•

### æ¯æœˆæ£€æŸ¥
- [ ] æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
- [ ] æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸
- [ ] æ£€æŸ¥æ•°æ®åº“å­˜å‚¨ä½¿ç”¨æƒ…å†µ

### æ¯å‘¨æ£€æŸ¥
- [ ] æŸ¥çœ‹åº”ç”¨è¿è¡ŒçŠ¶æ€
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰éƒ¨ç½²å¤±è´¥
- [ ] ç›‘æ§é”™è¯¯æ—¥å¿—

---

## ğŸ‰ å®Œæˆï¼

é…ç½®å®Œæˆåï¼Œæ‚¨å°†æ‹¥æœ‰ï¼š
- âœ… å®Œå…¨è‡ªåŠ¨åŒ–çš„ CI/CD æµç¨‹
- âœ… æ¨é€ä»£ç å³éƒ¨ç½²
- âœ… è‡ªåŠ¨æ•°æ®åº“è¿ç§»
- âœ… éƒ¨ç½²çŠ¶æ€ç›‘æ§

äº«å—è‡ªåŠ¨åŒ–éƒ¨ç½²çš„ä¾¿åˆ©å§ï¼ğŸš€
